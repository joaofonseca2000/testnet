<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Trader Testnet Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [currentPrice, setCurrentPrice] = useState(null);
            const [balance, setBalance] = useState(null);
            const [unrealizedPNL, setUnrealizedPNL] = useState(null);
            const [openOrders, setOpenOrders] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            const fetchData = async () => {
                try {
                    setLoading(true);
                    setError(null);

                    // Fetch all data in parallel
                    const [priceRes, balanceRes, pnlRes, ordersRes, transactionsRes] = await Promise.all([
                        fetch('/api/current-price'),
                        fetch('/api/balance'),
                        fetch('/api/unrealized-pnl'),
                        fetch('/api/open-orders'),
                        fetch('/api/transactions')
                    ]);

                    if (!priceRes.ok || !balanceRes.ok || !pnlRes.ok || !ordersRes.ok || !transactionsRes.ok) {
                        throw new Error('Failed to fetch data');
                    }

                    const [priceData, balanceData, pnlData, ordersData, transactionsData] = await Promise.all([
                        priceRes.json(),
                        balanceRes.json(),
                        pnlRes.json(),
                        ordersRes.json(),
                        transactionsRes.json()
                    ]);

                    setCurrentPrice(priceData.price);
                    setBalance(balanceData);
                    setUnrealizedPNL(pnlData);
                    setOpenOrders(ordersData.orders);
                    setTransactions(transactionsData);
                } catch (err) {
                    setError(err.message);
                    console.error('Error fetching data:', err);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchData();
                // Refresh data every 30 seconds
                const interval = setInterval(fetchData, 30000);
                return () => clearInterval(interval);
            }, []);

            // Portuguese number formatter
            const formatNumber = (number) => {
                if (number === null || number === undefined) return 'N/A';
                return parseFloat(number).toLocaleString('pt-PT', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            };

            // Portuguese date formatter for Lisbon timezone
            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                
                // Parse the date string that comes from the server
                const date = new Date(dateString);
                
                // Format for Portuguese locale with Lisbon timezone
                return date.toLocaleString('pt-PT', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false,
                    timeZone: 'Europe/Lisbon'
                });
            };

            if (loading) {
                return (
                    <div className="container mx-auto p-4">
                        <div className="text-center">
                            <div className="text-xl">Loading...</div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="container mx-auto p-4">
                        <div className="text-center text-red-600">
                            <div className="text-xl">Error: {error}</div>
                            <button 
                                onClick={fetchData}
                                className="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                            >
                                Retry
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container mx-auto p-4">
                    <h1 className="text-2xl font-bold mb-4 text-center">The Trader Testnet Dashboard</h1>
                    
                    {/* Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div className="bg-white p-4 rounded-lg shadow">
                            <h3 className="text-lg font-semibold mb-2">Current BTC Price</h3>
                            <p className="text-2xl font-bold text-blue-600">{formatNumber(currentPrice)}</p>
                        </div>
                        
                        <div className="bg-white p-4 rounded-lg shadow">
                            <h3 className="text-lg font-semibold mb-2">Available Balance</h3>
                            <p className="text-2xl font-bold text-green-600">{formatNumber(balance?.availableBalance)}</p>
                        </div>
                        
                        <div className="bg-white p-4 rounded-lg shadow">
                            <h3 className="text-lg font-semibold mb-2">Wallet Balance</h3>
                            <p className="text-2xl font-bold text-blue-600">{formatNumber(balance?.walletBalance)}</p>
                        </div>
                        
                        <div className="bg-white p-4 rounded-lg shadow">
                            <h3 className="text-lg font-semibold mb-2">Unrealized PNL</h3>
                            <p className={`text-2xl font-bold ${parseFloat(unrealizedPNL?.totalUnrealizedPNL || 0) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {formatNumber(unrealizedPNL?.totalUnrealizedPNL)}
                            </p>
                        </div>
                    </div>

                    {/* Open Orders */}
                    <div className="mb-6">
                        <h2 className="text-xl font-bold mb-4">Open Orders ({openOrders.length})</h2>
                        {openOrders.length > 0 ? (
                            <div className="bg-white rounded-lg shadow overflow-hidden">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Side</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {openOrders.map((order, index) => (
                                            <tr key={index}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{order.orderId}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{order.type}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{order.side}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{formatNumber(order.price)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        ) : (
                            <div className="bg-white p-4 rounded-lg shadow text-center text-gray-500">
                                No open orders
                            </div>
                        )}
                    </div>

                    {/* Recent Transactions */}
                    <div>
                        <h2 className="text-xl font-bold mb-4">Most Recent Transactions</h2>
                        {transactions.length > 0 ? (
                            <div className="bg-white rounded-lg shadow overflow-hidden">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Side</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Realized PNL</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {transactions.map((trade, index) => (
                                            <tr key={index}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{trade.symbol}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{trade.side}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{formatNumber(trade.price)}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{formatNumber(trade.qty)}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{formatDate(trade.time)}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm">
                                                    <span className={`font-medium ${parseFloat(trade.realizedPnl) < 0 ? 'text-red-600' : 'text-green-600'}`}>
                                                        {formatNumber(trade.realizedPnl)}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        ) : (
                            <div className="bg-white p-4 rounded-lg shadow text-center text-gray-500">
                                No recent transactions
                            </div>
                        )}
                    </div>

                    {/* Refresh Button */}
                    <div className="mt-6 text-center">
                        <button 
                            onClick={fetchData}
                            className="px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
                        >
                            Refresh Data
                        </button>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

